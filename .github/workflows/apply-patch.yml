name: Apply Self-Hosted UI Patch

# TEMPORARY WORKFLOW - DELETE AFTER SUCCESSFUL PATCH APPLICATION
# Purpose: Apply self-hosted-ui.patch to _worker.js and commit to main branch
# Location: This workflow is in MAIN branch, patch file is in TESTING branch

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch untuk commit (main/testing)'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - testing
      create_pr:
        description: 'Create Pull Request instead of direct commit?'
        required: true
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (test tanpa commit)'
        required: false
        default: false
        type: boolean
      apply_to_file:
        description: 'File target untuk patch'
        required: false
        default: '_worker.js'
        type: string

jobs:
  apply-patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: üì• Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0
      
      - name: üîç Verify patch file exists
        run: |
          if [ ! -f "self-hosted-ui.patch" ]; then
            echo "‚ùå Error: self-hosted-ui.patch not found!"
            exit 1
          fi
          echo "‚úÖ Patch file found"
          echo "üìÑ Patch file size: $(wc -c < self-hosted-ui.patch) bytes"
      
      - name: üîç Verify target file exists
        run: |
          TARGET_FILE="${{ github.event.inputs.apply_to_file }}"
          if [ ! -f "$TARGET_FILE" ]; then
            echo "‚ùå Error: $TARGET_FILE not found!"
            exit 1
          fi
          echo "‚úÖ Target file found: $TARGET_FILE"
          echo "üìÑ Original size: $(wc -c < $TARGET_FILE) bytes"
          cp "$TARGET_FILE" "${TARGET_FILE}.backup"
          echo "üíæ Backup created: ${TARGET_FILE}.backup"
      
      - name: üîß Setup Node.js for validation
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: üéØ Parse and apply patch
        id: apply
        run: |
          TARGET_FILE="${{ github.event.inputs.apply_to_file }}"
          PATCH_FILE="self-hosted-ui.patch"
          
          echo "üîÑ Starting patch application..."
          echo "üìã Target: $TARGET_FILE"
          echo "üì¶ Patch: $PATCH_FILE"
          
          cat > apply_patch.cjs << 'EOFJS'
          const fs = require('fs');
          const targetFile = process.argv[2];
          const patchFile = process.argv[3];
          console.log('üìñ Reading files...');
          let workerCode = fs.readFileSync(targetFile, 'utf8');
          const patchContent = fs.readFileSync(patchFile, 'utf8');
          console.log(`‚úÖ Worker code: ${workerCode.length} characters`);
          console.log(`‚úÖ Patch content: ${patchContent.length} characters`);
          const functionMatch = patchContent.match(/function handleSubPage[\s\S]*?^function generateSubPageHTML[\s\S]*?^}\n```/m);
          if (!functionMatch) {
            console.error('‚ùå Could not extract functions from patch');
            process.exit(1);
          }
          const newFunctions = functionMatch[0].replace(/^```javascript\n/, '').replace(/\n```$/, '').trim();
          console.log(`‚úÖ Extracted functions: ${newFunctions.length} characters`);
          const exportMatch = workerCode.match(/^export default \{/m);
          if (!exportMatch) {
            console.error('‚ùå Could not find "export default {" in worker code');
            process.exit(1);
          }
          const insertIndex = exportMatch.index;
          console.log(`üìç Insertion point found at index: ${insertIndex}`);
          if (workerCode.includes('function handleSubPage(')) {
            console.log('‚ö†Ô∏è  Functions already exist, will replace...');
            workerCode = workerCode.replace(/\/\/ ={40,}\n\/\/ SELF-HOSTED SUB PAGE[\s\S]*?(?=^export default \{)/m, '');
          }
          const beforeExport = workerCode.substring(0, insertIndex);
          const afterExport = workerCode.substring(insertIndex);
          const updatedCode = beforeExport + '// ' + '='.repeat(44) + '\n' + '// SELF-HOSTED SUB PAGE WITH CONFIG GENERATOR\n' + '// ' + '='.repeat(44) + '\n\n' + newFunctions + '\n\n' + afterExport;
          console.log(`‚úÖ New code size: ${updatedCode.length} characters`);
          const oldPattern = /if \(url\.pathname\.startsWith\("\/sub"\)\) \{\s*return Response\.redirect\([^}]+\}/;
          const newLogic = `if (url.pathname.startsWith("/sub")) {\n    return handleSubPage(url, env);\n  }`;
          if (oldPattern.test(updatedCode)) {
            const finalCode = updatedCode.replace(oldPattern, newLogic);
            console.log('‚úÖ Replaced redirect logic');
            fs.writeFileSync(targetFile, finalCode, 'utf8');
            console.log(`üíæ Updated ${targetFile}`);
            console.log(`üìä Final size: ${finalCode.length} characters`);
            fs.writeFileSync('patch_stats.txt', `original_size=${workerCode.length}\npatched_size=${finalCode.length}\ndiff=${finalCode.length - workerCode.length}\n`);
          } else {
            console.error('‚ùå Could not find redirect logic to replace');
            console.log('üîç Searching for: if (url.pathname.startsWith("/sub"))');
            process.exit(1);
          }
          EOFJS
          
          node apply_patch.cjs "$TARGET_FILE" "$PATCH_FILE"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Patch applied successfully!"
            if [ -f "patch_stats.txt" ]; then
              cat patch_stats.txt
              source patch_stats.txt
              echo "original_size=$original_size" >> $GITHUB_OUTPUT
              echo "patched_size=$patched_size" >> $GITHUB_OUTPUT
              echo "diff=$diff" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Patch application failed!"
            mv "${TARGET_FILE}.backup" "$TARGET_FILE"
            echo "‚ôªÔ∏è  Restored from backup"
            exit 1
          fi
      
      - name: üß™ Validate JavaScript syntax
        run: |
          TARGET_FILE="${{ github.event.inputs.apply_to_file }}"
          echo "üîç Validating JavaScript syntax..."
          node -c "$TARGET_FILE"
          if [ $? -eq 0 ]; then
            echo "‚úÖ JavaScript syntax is valid"
          else
            echo "‚ùå JavaScript syntax error detected!"
            mv "${TARGET_FILE}.backup" "$TARGET_FILE"
            exit 1
          fi
          echo "üîç Checking for common issues..."
          if grep -q "function handleSubPage" "$TARGET_FILE"; then
            echo "‚úÖ handleSubPage function found"
          else
            echo "‚ùå handleSubPage function not found!"
            exit 1
          fi
          if grep -q "function generateSubPageHTML" "$TARGET_FILE"; then
            echo "‚úÖ generateSubPageHTML function found"
          else
            echo "‚ùå generateSubPageHTML function not found!"
            exit 1
          fi
          if grep -q "return handleSubPage(url, env)" "$TARGET_FILE"; then
            echo "‚úÖ Redirect logic replaced"
          else
            echo "‚ùå Redirect logic not replaced!"
            exit 1
          fi
          echo "‚úÖ All validation checks passed!"
      
      - name: üìä Generate patch summary
        run: |
          echo "## üéâ Patch Application Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Changes" >> $GITHUB_STEP_SUMMARY
          echo "- **Target File**: \`${{ github.event.inputs.apply_to_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Original Size**: ${{ steps.apply.outputs.original_size }} chars" >> $GITHUB_STEP_SUMMARY
          echo "- **Patched Size**: ${{ steps.apply.outputs.patched_size }} chars" >> $GITHUB_STEP_SUMMARY
          echo "- **Diff**: ${{ steps.apply.outputs.diff }} chars" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Features Added" >> $GITHUB_STEP_SUMMARY
          echo "- üé® Self-hosted config generator UI" >> $GITHUB_STEP_SUMMARY
          echo "- üåç Advanced filtering" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ Multiple formats" >> $GITHUB_STEP_SUMMARY
          echo "- üì≤ QR code generation" >> $GITHUB_STEP_SUMMARY
      
      - name: üö´ Dry Run - Show diff
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "üìä DRY RUN - Showing changes:"
          git diff "${{ github.event.inputs.apply_to_file }}" || echo "No diff"
          echo "‚úÖ Dry run completed."
      
      - name: üîÄ Switch to target branch
        if: github.event.inputs.dry_run != 'true'
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          git fetch origin "$TARGET_BRANCH"
          if [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="feat/self-hosted-ui-$(date +%s)"
            git checkout -b "$BRANCH_NAME" "origin/$TARGET_BRANCH"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          else
            git checkout "$TARGET_BRANCH"
          fi
          git checkout testing -- "${{ github.event.inputs.apply_to_file }}"
      
      - name: üìù Commit changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ github.event.inputs.apply_to_file }}"
          git commit -m "feat(ui): apply self-hosted config generator patch" -m "Self-hosted HTML interface untuk proxy configuration." -m "Applied via CI workflow from testing branch patch."
      
      - name: üöÄ Push to branch
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.create_pr != 'true'
        run: |
          git push origin "${{ github.event.inputs.target_branch }}"
          echo "‚úÖ Successfully pushed to ${{ github.event.inputs.target_branch }}"
      
      - name: üì¨ Create Pull Request
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.create_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          BRANCH_NAME="${{ env.branch_name }}"
          
          git push origin "$BRANCH_NAME"
          
          cat > pr_body.md << 'EOFBODY'
          ## üöÄ Self-Hosted Config Generator
          
          This PR applies the self-hosted UI patch to replace external redirect.
          
          ### üìù Changes
          - ‚ùå Removed: External redirect to foolvpn.web.id/nautica
          - ‚úÖ Added: Self-hosted HTML config generator
          - ‚úÖ Added: Modern dark theme UI
          
          ### ‚ú® Features
          - üåç Country filtering (ID,SG,JP,US...)
          - üîê Protocol selection (VLESS/Trojan/SS)
          - üîå Port selection (443 TLS/80 NTLS)
          - üìÑ Multiple formats (raw, v2ray, clash, sfa, bfr)
          - üì≤ QR code generation
          - üíæ Download & copy functionality
          - üîó Share subscription links
          - üáÆüá© Bahasa Indonesia
          
          ### üß™ Testing
          ```bash
          wrangler deploy
          curl -I https://YOUR_WORKER.workers.dev/sub
          ```
          
          Applied via CI workflow. Review before merging.
          EOFBODY
          
          gh pr create \
            --base "$TARGET_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "üé® feat(ui): Self-hosted config generator" \
            --body-file pr_body.md \
            --label "enhancement,ui,automated"
          
          rm -f pr_body.md
      
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f "${{ github.event.inputs.apply_to_file }}.backup"
          rm -f apply_patch.cjs patch_stats.txt
      
      - name: üéâ Success notification
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          echo "‚úÖ Patch applied successfully!" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
            echo "Pull Request created. Review and merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "Changes pushed to ${{ github.event.inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          fi