name: Apply Self-Hosted UI Patch

# TEMPORARY WORKFLOW - DELETE AFTER SUCCESSFUL PATCH APPLICATION
# Purpose: Copy pre-patched _worker.js from testing to main branch

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch untuk commit (main/testing)'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - testing
      create_pr:
        description: 'Create Pull Request instead of direct commit?'
        required: true
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (test tanpa commit)'
        required: false
        default: false
        type: boolean
      apply_to_file:
        description: 'File target untuk patch'
        required: false
        default: '_worker.js'
        type: string

jobs:
  apply-patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: üì• Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: üîç Validate patched file
        id: validate
        run: |
          TARGET_FILE="${{ github.event.inputs.apply_to_file }}"
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "‚ùå Error: $TARGET_FILE not found in testing branch!"
            exit 1
          fi
          
          echo "‚úÖ File found: $TARGET_FILE"
          
          # Get size
          FILE_SIZE=$(wc -c < "$TARGET_FILE")
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          echo "üìÑ File size: $FILE_SIZE bytes"
          
          # Validate syntax
          echo "üîç Validating JavaScript syntax..."
          node -c "$TARGET_FILE"
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Syntax validation failed!"
            exit 1
          fi
          
          echo "‚úÖ Syntax validation passed"
          
          # Check functions
          if grep -q "function handleSubPage" "$TARGET_FILE" && \
             grep -q "function generateSubPageHTML" "$TARGET_FILE" && \
             grep -q "return handleSubPage(url, env)" "$TARGET_FILE"; then
            echo "‚úÖ All required functions found"
          else
            echo "‚ùå Required functions not found!"
            exit 1
          fi
          
          echo "‚úÖ All validation checks passed!"
      
      - name: üö´ Dry Run
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "üìä DRY RUN MODE"
          echo "‚úÖ Would copy ${{ github.event.inputs.apply_to_file }} from testing to ${{ github.event.inputs.target_branch }}"
          echo "üìÑ File size: ${{ steps.validate.outputs.file_size }} bytes"
          echo "üí° Run with dry_run=false to apply changes"
      
      - name: üîÄ Switch to target branch
        if: github.event.inputs.dry_run != 'true'
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          git fetch origin "$TARGET_BRANCH"
          
          if [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="feat/self-hosted-ui-$(date +%s)"
            git checkout -b "$BRANCH_NAME" "origin/$TARGET_BRANCH"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
            echo "‚úÖ Created PR branch: $BRANCH_NAME"
          else
            git checkout "$TARGET_BRANCH"
            echo "‚úÖ Checked out: $TARGET_BRANCH"
          fi
          
          # Copy file from testing branch
          git checkout testing -- "${{ github.event.inputs.apply_to_file }}"
          echo "‚úÖ Copied patched file from testing"
          
          # Validate again
          node -c "${{ github.event.inputs.apply_to_file }}"
          echo "‚úÖ Post-copy validation passed"
      
      - name: üìù Commit
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ github.event.inputs.apply_to_file }}"
          git commit -m "feat(ui): add self-hosted config generator" \
            -m "Self-hosted HTML UI untuk proxy configuration." \
            -m "" \
            -m "Features:" \
            -m "- Modern dark theme UI" \
            -m "- Country/protocol/port filtering" \
            -m "- Multiple formats (raw, v2ray, clash, sfa, bfr)" \
            -m "- QR code generation" \
            -m "- Download & copy functionality" \
            -m "- Bahasa Indonesia" \
            -m "" \
            -m "Applied from testing branch via CI."
          echo "‚úÖ Committed"
      
      - name: üöÄ Push
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.create_pr != 'true'
        run: |
          git push origin "${{ github.event.inputs.target_branch }}"
          echo "‚úÖ Pushed to ${{ github.event.inputs.target_branch }}"
      
      - name: üì¨ Create PR
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.create_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "${{ env.branch_name }}"
          
          cat > pr.md << 'EOF'
          ## üöÄ Self-Hosted Config Generator
          
          Adds self-hosted HTML UI for proxy config generation.
          
          ### Changes
          - ‚ùå Removed: External redirect
          - ‚úÖ Added: Self-hosted HTML generator
          - ‚úÖ Added: Modern UI with filtering
          
          ### Features
          - üåç Country filtering
          - üîê Protocol selection
          - üîå Port selection
          - üìÑ Multiple formats
          - üì≤ QR codes
          - üáÆüá© Indonesian
          
          ### Test
          ```bash
          wrangler deploy
          curl https://YOUR_WORKER.workers.dev/sub
          ```
          EOF
          
          gh pr create \
            --base "${{ github.event.inputs.target_branch }}" \
            --head "${{ env.branch_name }}" \
            --title "üé® feat(ui): Self-hosted config generator" \
            --body-file pr.md \
            --label "enhancement,ui"
          
          rm pr.md
      
      - name: üìä Summary
        if: success()
        run: |
          echo "## ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "File: \`${{ github.event.inputs.apply_to_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Size: ${{ steps.validate.outputs.file_size }} bytes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "Mode: Dry run" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
            echo "Created PR to \`${{ github.event.inputs.target_branch }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Pushed to \`${{ github.event.inputs.target_branch }}\`" >> $GITHUB_STEP_SUMMARY
          fi