name: ‚õÖ Deploy to Cloudflare Workers

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - testing

jobs:
  validate:
    name: üîç Validate Worker Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üîç Check JavaScript syntax
        run: |
          echo "::group::Syntax Check"
          node --check _worker.js
          echo "‚úÖ Syntax check passed"
          echo "::endgroup::"

      - name: üìã Check file integrity
        run: |
          echo "::group::File Integrity Check"
          
          # Check if file is complete (no truncation)
          if ! tail -1 _worker.js | grep -q '[;}]'; then
            echo "::error::_worker.js appears truncated (missing closing bracket/semicolon)"
            exit 1
          fi
          
          # Check file size (should be > 20KB for a complete worker)
          SIZE=$(stat -f%z _worker.js 2>/dev/null || stat -c%s _worker.js)
          if [ "$SIZE" -lt 20000 ]; then
            echo "::error::_worker.js file size too small ($SIZE bytes), possible truncation"
            exit 1
          fi
          
          echo "‚úÖ File size: $SIZE bytes"
          echo "‚úÖ File integrity check passed"
          echo "::endgroup::"

      - name: üî¨ Lint with ESLint (optional)
        continue-on-error: true
        run: |
          echo "::group::ESLint Check"
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            bun run eslint _worker.js || echo "::warning::ESLint found issues (non-blocking)"
          else
            echo "::notice::No ESLint config found, skipping linting"
          fi
          echo "::endgroup::"

      - name: üß™ Wrangler dry-run (syntax + config validation)
        run: |
          echo "::group::Wrangler Validation"
          bunx wrangler deploy --dry-run --outdir=./dist
          echo "‚úÖ Wrangler dry-run passed"
          echo "::endgroup::"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: ‚úÖ Validation complete
        run: |
          echo "::notice::‚úÖ All validation checks passed!"
          echo "::notice::üìÑ File: _worker.js"
          echo "::notice::üåø Branch: ${{ github.ref_name }}"
          echo "::notice::üöÄ Ready for deployment"

  deploy:
    name: üöÄ Deploy Worker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate  # CRITICAL: Only deploy if validation passes
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üßπ Clean Deployment - Delete existing worker
        continue-on-error: true
        run: |
          echo "::group::Pre-deployment Cleanup"
          echo "‚ö†Ô∏è Initiating clean deployment (5-10s downtime)"
          echo "üéØ Reason: Clear stale connection pools and global state"
          
          # Try to delete with retry mechanism
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "üîÑ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            if bunx wrangler delete --force; then
              echo "‚úÖ Worker deleted successfully"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Retrying in 3 seconds..."
                sleep 3
              else
                echo "::warning::Failed to delete after $MAX_RETRIES attempts (worker may not exist)"
                echo "::notice::Proceeding with deployment..."
              fi
            fi
          done
          
          # Wait for deletion to propagate globally
          echo "‚è≥ Waiting 5 seconds for global propagation..."
          sleep 5
          
          echo "‚úÖ Cleanup phase completed"
          echo "::endgroup::"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: üöÄ Deploy fresh worker instance
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          wranglerVersion: "4.55.0"
        env:
          GIT_COMMIT_ID: ${{ github.sha }}

      - name: ‚è≥ Wait for deployment propagation
        run: |
          echo "::group::Deployment Propagation"
          echo "‚è≥ Waiting 15 seconds for global edge deployment..."
          sleep 15
          echo "‚úÖ Propagation wait completed"
          echo "::endgroup::"

      - name: üß™ Post-deployment smoke test
        run: |
          echo "::group::Smoke Test"
          
          WORKER_URL="https://hoshiyomi.qzz.io"
          echo "üîó Testing fresh worker at: $WORKER_URL"
          
          # Test with retries (fresh worker might need warmup)
          MAX_TEST_RETRIES=5
          TEST_RETRY=0
          SUCCESS=false
          
          while [ $TEST_RETRY -lt $MAX_TEST_RETRIES ]; do
            echo "üîÑ Test attempt $((TEST_RETRY + 1))/$MAX_TEST_RETRIES..."
            
            # Test root endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WORKER_URL/" --max-time 10 || echo "000")
            echo "üì° Root endpoint: HTTP $HTTP_CODE"
            
            # Test API endpoint
            API_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WORKER_URL/api/v1/myip" --max-time 10 || echo "000")
            echo "üì° API endpoint: HTTP $API_CODE"
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ] && [ "$API_CODE" -eq 200 ]; then
              echo "‚úÖ Worker is responding correctly!"
              SUCCESS=true
              
              # Show actual response
              RESPONSE=$(curl -s "$WORKER_URL/api/v1/myip" --max-time 10 || echo "{}")
              echo "üìä API Response: $RESPONSE"
              break
            else
              TEST_RETRY=$((TEST_RETRY + 1))
              if [ $TEST_RETRY -lt $MAX_TEST_RETRIES ]; then
                echo "‚è≥ Worker warming up, retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "::error::Worker failed smoke test after $MAX_TEST_RETRIES attempts"
            echo "::error::Manual verification required at: $WORKER_URL"
            exit 1
          fi
          
          echo "::notice::‚úÖ Smoke test passed!"
          echo "::endgroup::"

      - name: üî¨ Test WebSocket connection (optional)
        continue-on-error: true
        run: |
          echo "::group::WebSocket Test"
          echo "üîó Testing WebSocket upgrade capability..."
          
          # Test WebSocket endpoint with proxy path
          WS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Upgrade: websocket" \
            -H "Connection: Upgrade" \
            -H "Sec-WebSocket-Version: 13" \
            -H "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==" \
            "https://hoshiyomi.qzz.io/1.1.1.1-443" \
            --max-time 10 || echo "000")
          
          if [ "$WS_CODE" -eq 101 ]; then
            echo "‚úÖ WebSocket upgrade successful (HTTP $WS_CODE)"
          elif [ "$WS_CODE" -eq 426 ] || [ "$WS_CODE" -eq 400 ]; then
            echo "‚ö†Ô∏è WebSocket test inconclusive (HTTP $WS_CODE) - may need client test"
          else
            echo "::warning::WebSocket test: HTTP $WS_CODE"
          fi
          
          echo "::endgroup::"

      - name: ‚úÖ Deployment complete
        run: |
          echo "::notice::üéâ Clean deployment successful!"
          echo "::notice::üåø Branch: ${{ github.ref_name }}"
          echo "::notice::üìù Commit: ${{ github.sha }}"
          echo "::notice::üîó URL: https://hoshiyomi.qzz.io"
          echo "::notice::‚ôªÔ∏è Fresh worker instance with cleared state"
          echo "::notice::üîå Connection pool: Reset"
          echo "::notice::üíæ Cache: Cleared"
